{% extends "base.html" %}
{% block title %}Add Book{% endblock %}
{% block content %}
<h1>Add a New Book</h1>
<form method="post">
<<<<<<< main
  <div class="mb-3">
    <button type="button" class="btn btn-secondary w-100" onclick="startScanner()">Scan Barcode</button>
  </div>
  <div class="mb-3">
    <label for="isbn" class="form-label">ISBN (type or scan)</label>
    <!-- Use type="tel" and pattern="\d*" for mobile keypad -->
    <input id="isbn" name="isbn" class="form-control" value="{{ request.form.isbn or '' }}" type="tel" pattern="\d*" inputmode="numeric">
  </div>
  <div id="scanner" class="mb-3" style="width:100%; max-width:500px; height:auto; min-height:200px; display:none;"></div>
  <div class="mb-3">
    <button name="fetch" value="1" type="submit" class="btn btn-info w-100">Fetch Book Data from ISBN</button>
  </div>
  <div class="mb-3">
    <label for="title" class="form-label">Title</label>
    <input id="title" name="title" class="form-control" value="{{ book_data.title if book_data else request.form.title or '' }}">
  </div>
  <div class="mb-3">
    <label for="author" class="form-label">Author</label>
    <input id="author" name="author" class="form-control" value="{{ book_data.author if book_data else request.form.author or '' }}">
  </div>
  <div class="mb-3">
    <label for="start_date" class="form-label">Start Date</label>
    <input id="start_date" name="start_date" class="form-control" type="date" value="{{ request.form.start_date or '' }}">
  </div>
  <div class="mb-3">
    <label for="finish_date" class="form-label">Finish Date</label>
    <input id="finish_date" name="finish_date" class="form-control" type="date" value="{{ request.form.finish_date or '' }}">
  </div>
=======
  <button type="button" class="btn btn-secondary" onclick="startScanner()">Scan Barcode</button>

  <!-- ISBN input -->
  <input id="isbn" name="isbn" class="form-control" value="{{ request.form.isbn or '' }}" type="tel" pattern="\d*" inputmode="numeric">

  <!-- Constrained scanner box -->
  <div id="scanner" style="
    width: 300px;
    height: 200px;
    display: none;
    border: 2px solid #ccc;
    margin: 1rem 0;
    overflow: hidden;
    position: relative;
    background-color: #000;
  "></div>

  <!-- Fetch and book data inputs -->
  <button name="fetch" value="1" type="submit">Fetch Book Data</button><br>
  Title: <input id="title" name="title" value="{{ book_data.title if book_data else request.form.title or '' }}"><br>
  Author: <input name="author" value="{{ book_data.author if book_data else request.form.author or '' }}"><br>
  Start Date: <input name="start_date" type="date"><br>
  Finish Date: <input name="finish_date" type="date"><br>

>>>>>>> main
  {% if book_data and book_data.cover %}
  <div class="mb-3 text-center">
    <img src="{{ book_data.cover }}" alt="Book Cover" class="img-fluid rounded" style="max-height:200px;">
  </div>
  {% endif %}
<<<<<<< main
  <div class="form-check mb-3">
    <input class="form-check-input" type="checkbox" name="want_to_read" id="want_to_read" {% if request.form.want_to_read %}checked{% endif %}>
    <label class="form-check-label" for="want_to_read">
      Want to Read
    </label>
  </div>
  <div class="form-check mb-3">
    <input class="form-check-input" type="checkbox" name="library_only" id="library_only" {% if request.form.library_only %}checked{% endif %}>
    <label class="form-check-label" for="library_only">
      Add to Library Only (not for reading)
    </label>
  </div>
  <div class="d-grid gap-2">
    <input type="submit" name="add" value="Add Book" class="btn btn-primary">
    <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary">Back to list</a>
  </div>
</form>
=======

  <label>
    <input type="checkbox" name="want_to_read" {% if request.form.want_to_read %}checked{% endif %}>
    Want to Read
  </label><br>

  <label>
    <input type="checkbox" name="library_only" {% if request.form.library_only %}checked{% endif %}>
    Add to Library Only (not for reading)
  </label><br>

  <input type="submit" name="add" value="Add Book">
</form>

<a href="{{ url_for('main.index') }}">Back to list</a>
>>>>>>> main

<!-- QuaggaJS -->
<script src="https://unpkg.com/@ericblade/quagga2@1.2.6/dist/quagga.min.js"></script>
<script>
let quaggaStarted = false;

function startScanner() {
  const scannerDiv = document.getElementById('scanner');
  scannerDiv.style.display = 'block';

  if (quaggaStarted) {
    Quagga.stop();
    quaggaStarted = false;
  }

  Quagga.init({
    inputStream: {
      name: "Live",
      type: "LiveStream",
      target: scannerDiv,
      constraints: {
        facingMode: "environment"
      }
    },
    decoder: {
      readers: ["ean_reader", "ean_8_reader", "upc_reader", "upc_e_reader", "code_39_reader"]
    }
  }, function(err) {
    if (err) {
      alert("Error starting scanner: " + err);
      scannerDiv.style.display = 'none';
      return;
    }
    Quagga.start();
    quaggaStarted = true;
  });

  Quagga.offDetected();
  Quagga.onDetected(function(result) {
    if (result && result.codeResult && result.codeResult.code) {
      const code = result.codeResult.code;
      if (code.length === 13 && code.startsWith("978")) {
        document.getElementById('isbn').value = code;
        Quagga.stop();
        quaggaStarted = false;
        scannerDiv.style.display = 'none';
        Quagga.offDetected();
      }
    }
  });
}
</script>
{% endblock %}